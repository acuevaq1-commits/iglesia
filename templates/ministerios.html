{% extends "base.html" %}

{% block title %}Tab 1{% endblock %}

{% block content %}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ministerios</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-GLhlTQ8iRABdZLl6O3oVMWSktQOp6b7In1Zl3/Jr59b6EGGoI1aFkw7cmDA6j6gD" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js" integrity="sha384-w76AqPfDkMBDXo30jS1Sgez6pr3x5MlQ1ZAGC+nuZB+EYdgRZgiwxhTBTkF7CXvN" crossorigin="anonymous"></script>
</head>
<body>
    <nav class="navbar navbar-expand-lg bg-light">
        <div class="container-fluid">
            <a class="navbar-brand fw-bolder"> | Ministerios - Reuniones | </a>
            <span>Bienvenido/a {{session['name']}} {{session['surnames']}}<a href="{{url_for('logout')}}" class="mx-3">Salir</a></span>
        </div>
    </nav>
    <!---------------------------------------- Cards ---------------------------------------->
    <div class="container">
        <br>       
        <button class="btn btn-success btn-sm" id="btnNuevoMinisterio" data-bs-toggle="modal" data-bs-target="#Ministerio-modal" title="Nuevo Ministerio">
            &nbsp;&nbsp;&nbsp;<i class="bi bi-diagram-3-fill" width='18px' style="cursor:pointer;"></i>
            Nuevo &nbsp;&nbsp;&nbsp;
        </button>
        <br>aaa<br>
        <div class="row row-col-1 row-cols-sm-1 row-cols-md-3 row-cols-lg-4 mt-3">
            {% for minist in ministerio_ %}
                <div class="col-md-3">
                    <div class="card">
                        {% if minist[3] == 'M' %}
                            <div class="card-header bg-danger-subtle text-danger-emphasis">
                                <b>{{minist[3]}}: </b> {{minist[1]}}
                            </div>
                        {% else %}
                            <div class="card-header bg-info-subtle text-info-emphasis">
                                <b>{{minist[3]}}: </b> {{minist[1]}}
                            </div>
                        {% endif %}
                        
                        <div class="card-body">
                            {{minist[2]}}
                        </div>
                        <div class="card-footer d-flex justify-content-between">
                            <button class="btn btn-warning btn-sm" title="Editar Ministerio" id="btnEditarMin"
                                data-bs-toggle="modal"
                                data-bs-target="#Ministerio-modal"
                                width='18px'
                                style="cursor:pointer;"
                                data-id="{{ minist[0] }}">
                                <i class="bi bi-pencil-square"></i> Editar
                            </button>
                            <button class="btn btn-danger btn-sm" title="Estado del Ministerio" id="btnEstado"
                                width="18px"
                                style="cursor:pointer;"
                                data-url="{{ url_for('ministerio.estado_ministerio', codigo=minist[0]) }}">
                                <i class="bi bi-pencil"></i>
                            </button>
                            <button class="btn btn-danger btn-sm" title="Eliminar Ministerio" id="btnEliminarMin"
                                width="18px"
                                style="cursor:pointer;"
                                data-url="{{ url_for('ministerio.eli_ministerio', codigo=minist[0]) }}">
                                <i class="bi bi-trash"></i> Eliminar
                            </button>
                        </div>
                    </div>
                    <br>
                </div>                
            {% endfor %}
        </div>
        <div id="msjalPie" style="color:red; margin-top:10px;"></div>       
    </div>
    <!------------------------------------------------------------------------------------------->
    <div class="modal fade" id="Ministerio-modal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                <h1 class="modal-title fs-5" id="exampleModalLabel"> :: <i class="bi bi-diagram-3-fill"></i> Nuevo :: </h1>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                <form id="formMinisterio" action="/nuevo_ministerio" method="post" enctype="multipart/form-data">                
                    <input id="valorCode" name="valorCode" type="hidden"/>

                    <div class="row mb-3">
                        <div class="col-md-3" style="text-align: right;">
                            <label class="form-label" >Seleccione:</label>
                        </div>
                        <div class="col-md-9" style="text-align: left;">
                            <select class="form-select" id="cboOpcion" name="cboOpcion">
                                <option value="">Seleccione una opción</option>
                                <option value="M">Ministerio</option>
                                <option value="R">Reunión</option>                            
                            </select>
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-3" style="text-align: right;">
                            <label class="form-label" >Nombre:</label>                            
                        </div>
                        <div class="col-md-9" style="text-align: left;">                            
                            <input type="text" autocomplete="off" class="form-control error" id="txt_nombre" name="txt_nombre" placeholder="Ejm:  Evangelismo">
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-3" style="text-align: right;">
                            <label class="form-label" >Descripcion:</label>                            
                        </div>
                        <div class="col-md-9" style="text-align: left;">
                            <input type="text" autocomplete="off" class="form-control error" id="txt_descripcion" name="txt_descripcion" placeholder="Ejm:  Descripcion del Ministerio...">
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-3" style="text-align: right;">
                            <label class="form-label" >Funciones:</label>                            
                        </div>
                        <div class="col-md-9" style="text-align: left;">
                            <textarea type="text" autocomplete="off" class="form-control" id="txt_funciones" name="txt_funciones" rows="10" placeholder="Funciones" required></textarea>
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-3" style="text-align: right;">
                            <label class="form-label" >Adjuntar:</label>
                        </div>
                        <div class="col-md-9" style="text-align: left;">
                            <input type="file" id="ruta_archivo" name="ruta_archivo" accept=".pdf,.jpg,.png,.xlsx,.csv"><br><br>
                            <button onclick="subirArchivo()">Subir Archivo</button>
                            <p id="resultado" style="color: green; font-weight: bold;"></p>
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-3" style="text-align: right;">
                            <label class="form-label" >Estado:</label>
                        </div>
                        <div class="col-md-9" style="text-align: left;">                            
                            <input type="checkbox" id="chck_estado" name="chck_estado" value="A"> Activo
                        </div>
                    </div>
                    <div id="mensaje" style="color:red; margin-top:10px;"></div>
                    <br><br>
                    <div class="row mb-3">
                        <div class="col-md-3"></div>
                        <div class="col-md-6" style="text-align: center;">
                            <button type="submit" name="action" value="guardar" class="btn btn-success w-100">Guardar</button>
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-3"></div>
                        <div class="col-md-6" style="text-align: center;">
                            <button type="button" id="btnCerrar" class="btn btn-outline-danger w-100" data-bs-dismiss="modal">Cerrar</button>
                        </div>
                    </div>
                </form>
                </div>
            </div>
        </div>
    </div>

    <!-- JS -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <!-- DataTables + integración Bootstrap 5 -->
    <script src="https://cdn.datatables.net/1.13.8/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.8/js/dataTables.bootstrap5.min.js"></script>
    <script src="https://cdn.datatables.net/responsive/2.5.0/js/dataTables.responsive.min.js"></script>
    <script src="https://cdn.datatables.net/responsive/2.5.0/js/responsive.bootstrap5.min.js"></script>

    <script>        
        const opcionesIniciales = {
            responsive: true,
            pageLength: 10,
            lengthMenu: [[10, 25, 50, 100, -1], [8, 25, 50, 100, 'Todos']],
            deferRender: true,
            language: { url: 'https://cdn.datatables.net/plug-ins/1.13.8/i18n/es-ES.json' },
            dom: "<'row mb-2'<'col-sm-6'l><'col-sm-6'f>> <'row'<'col-12'tr>> <'row mt-2'<'col-sm-5'i><'col-sm-7'p>>",
            columns: [
                { "data": "" },
                { "data": "nombres" },
                { "data": "apellidos" },
                { "data": "telefono", className: "dt-center" },
                { "data": "documento", className: "dt-center" },
                { "data": "" }
            ],
            columnDefs: [
                {
                    targets: [0],
                    render: function (data, type, row, meta) {
                        return meta.row + 1;
                    }
                },
                {
                    targets: [2,3,4,5],
                    orderable: false,  // desactiva ordenamiento
                    searchable: false  // desactiva búsqueda
                }
            ]
        };
        /*******************************************************************************/
        $(document).ready(function () {
            //let dt = $('#tablaPersonas').DataTable(opcionesIniciales);
            
            document.getElementById("btnCerrar").addEventListener("click", () => {
                document.getElementById("cboOpcion").value = "";
                document.getElementById("txt_nombre").value = "";
                document.getElementById("txt_descripcion").value = "";
                document.getElementById("txt_funciones").value = "";
            });
            /*------------------------------------------------------------------------------*/
            document.getElementById("btnNuevoMinisterio").addEventListener("click", () => {
                document.getElementById("cboOpcion").value = "";
                document.getElementById("txt_nombre").value = "";
                document.getElementById("txt_descripcion").value = "";
                document.getElementById("txt_funciones").value = "";
            });            
            /*------------------------------------------------------------------------------*/
            document.getElementById("formMinisterio").addEventListener("submit", async (e) => {
                //alert("submit");
                codigo = document.getElementById('valorCode').value;

                e.preventDefault(); // evitar recargar
                const formData = new FormData(e.target);
                const response = await fetch("/nuevo_ministerio", { method: "POST", body: formData });

                const data = await response.json();
                const mensaje = document.getElementById("mensaje");
                
                if (data.error) {
                    mensaje.style.color = "red";
                    mensaje.textContent = data.error;
                } else if (data.success) {
                    mensaje.style.color = "green";
                    mensaje.textContent = data.success;
                    //e.target.reset(); // limpiar formulario
                    //cargarTabla();
                }
            });
        });
        /*******************************************************************************/
        $(document).on('click', '#btnEliminarMin', function (e) {
            e.preventDefault();
            const mensajeDiv = document.getElementById("msjalPie");
            const url = this.dataset.url || this.href;
            if (!confirm('¿Confirma que desea eliminar registro?')) return;            
            fetch(url)
                .then(r => r.json()) // ✅ convierte la respuesta a JSON
                    .then(data => {

                    if (data.status) {
                        alertHTML = '<div class="alert alert-info alert-dismissible fade show mt-2" role="alert"> ' + data.mensaje +' <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Cerrar"></button></div>';
                    } else
                        alertHTML = '<div class="alert alert-danger alert-dismissible fade show mt-2" role="alert"> ❌ ' + data.mensaje +' <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Cerrar"></button></div>';
                    
                    mensajeDiv.innerHTML = alertHTML;
                    setTimeout(() => {
                        const alerta = mensajeDiv.querySelector(".alert");
                        if (alerta) {
                            alerta.classList.remove("show"); // inicia la animación de fade
                            alerta.classList.add("hide");                            
                            alerta.addEventListener("transitionend", () => alerta.remove()); // quitar del DOM tras animación (opcional)
                        }
                    }, 3000);                        
                })
                .then(() => cargarTabla())
                .catch(err => alert('Error eliminando: ' + err.message));
        });
        /*******************************************************************************/
        document.addEventListener('click', async (e) => {              
            const img = e.target.closest('#btnEditarMin'); //.imgEditar
            if (!img) return;

            const codigo = img.dataset.id;
            document.getElementById('valorCode').value = codigo;

            try {
                const resp = await fetch(`/edit_ministerio/${codigo}`, { headers: { 'Accept': 'application/json' }, cache: 'no-store' });
                if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
                const minis = await resp.json();
                document.getElementById('cboOpcion').value  = minis.opcion;
                document.getElementById('txt_nombre').value  = minis.nombre;
                document.getElementById('txt_descripcion').value= minis.descripcion;
                
            } catch (err) {
                alert(err.message);
            }
        });
        /*******************************************************************************/
        async function cargarTabla() {
            alert("recarga");
            // try {
            //     const res = await fetch('/tblministerios', { cache: 'no-store' });
            //     const htmlTabla = await res.text();

            //     // Si ya estaba inicializada, destrúyela antes de cambiar el DOM
            //     if ($.fn.DataTable.isDataTable('#tablaPersonas')) {
            //         $('#tablaPersonas').DataTable().destroy();
            //     }
                
            //     $('#tablaPersonas tbody').html(htmlTabla);     // inserta las <tr> renderizadas
            //     $('#tablaPersonas').DataTable(opcionesIniciales);
            // } catch (e) {
            //     console.error('Error cargando tabla:', e);
            // }
        }
        /*******************************************************************************/
        async function subirArchivo() {
            const input = document.getElementById('ruta_archivo');
            const archivo = input.files[0];

            if (!archivo) {
                alert("Por favor selecciona un archivo primero");
                return;
            }

            // Construir el form-data
            const formData = new FormData();
            formData.append("ruta_archivo", archivo);

            try {
                const response = await fetch("/upload_file", {
                    method: "POST",
                    body: formData
                });

                const data = await response.json();

                alert(data);
                console.log(data);
                console.log(data.mensaje);
                document.getElementById("resultado").innerText = data.mensaje;
                alert("fffff");
            } catch (error) {
                console.error("Error:", error);
                document.getElementById("resultado").innerText = "Error al subir el archivo ❌";
            }
        }
    </script>

</body>
</html>

{% endblock %}