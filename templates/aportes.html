{% extends "base.html" %}

{% block title %}Tab 1{% endblock %}

{% block content %}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aportes</title>
    <style>
        /* (Opcional) si usas Bootstrap */
        #tablaAportes.table thead th {
            background-color: #f67b00;
            color: #fff;
        }

        .table.display  tbody tr:nth-child(odd) td,
        .table.display tbody tr:nth-child(odd) th {
            background-color: #ffe1b6;
        }

        .table.display tbody tr:nth-child(even) td,
        .table.display tbody tr:nth-child(even) th {
            background-color: #fbecda;
            color:#000000;
        }
    </style>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-GLhlTQ8iRABdZLl6O3oVMWSktQOp6b7In1Zl3/Jr59b6EGGoI1aFkw7cmDA6j6gD" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js" integrity="sha384-w76AqPfDkMBDXo30jS1Sgez6pr3x5MlQ1ZAGC+nuZB+EYdgRZgiwxhTBTkF7CXvN" crossorigin="anonymous"></script>

    <!-- Bootstrap 5 
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">-->

    <!-- DataTables + integración Bootstrap 5 -->
    <link href="https://cdn.datatables.net/1.13.8/css/dataTables.bootstrap5.min.css" rel="stylesheet">
    <link href="https://cdn.datatables.net/responsive/2.5.0/css/responsive.bootstrap5.min.css" rel="stylesheet">
</head>
<body>
    <nav class="navbar navbar-expand-lg bg-light">
        <div class="container-fluid">
            <a class="navbar-brand fw-bolder"> | Aportes | </a>
            <span>Bienvenido/a {{session['name']}} {{session['surnames']}}<a href="{{url_for('logout')}}" class="mx-3">Salir</a></span>
        </div>
    </nav>
    
    <div class="container">
        <div style="width: 100%; margin: 30px auto;" ><!-- style="max-width: 900px; margin: 30px auto;"-->
            <button class="btn btn-primary btn-sm" id="btnNuevoAporte" data-bs-toggle="modal" data-bs-target="#Aporte-modal" title="Nuevo Aporte">
                &nbsp;&nbsp;&nbsp;<i class="bi bi-person-plus-fill" width='18px' style="cursor:pointer;"></i>
                Nuevo Aporte &nbsp;&nbsp;&nbsp;
            </button>
            <br><br>
            <table id="tablaAportes" class="display table table-striped table-hover table-bordered table-sm align-middle" style="width:100%">
                <thead>
                    <tr>
                        <th style="width: 5%;">Item</th>
                        <th>Tipo</th>
                        <th>Fecha</th>
                        <th>Turno</th>
                        <th>Monto</th>
                        <th style="width: 10%;">Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    {% include "_aporte.html" %}
                </tbody>
            </table>
            <div id="msjTabla" style="color:red; margin-top:10px;"></div>
        </div>
    </div>


    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
            <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
            {% endfor %}
        {% endif %}
    {% endwith %}


    

    <!-- Registrar Aporte -->
    <div class="modal fade" id="Aporte-modal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">    
        <div class="modal-dialog">
        <div class="modal-content">            
            <div class="modal-header">
                <h1 class="modal-title fs-5" id="exampleModalLabel"> :: <i class="bi bi-file-person"></i> Aporte :: </h1>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">                
                <form id="formAporte" action="/nuevo_aporte" method="post">
                    <input id="valorCode" name="valorCode" type="hidden"/>

                    <div class="row mb-3">
                        <div class="col-md-3" style="text-align: right;">
                            <label class="form-label" >Persona:</label>
                        </div>
                        <div class="col-md-9" style="text-align: left;">
                            <select class="form-select" id="cboPersona" name="cboPersona">
                                <option value="">Seleccione una Persona</option>
                                {% for perso in listaPersona %}
                                    <option value="{{ perso[0] }}">{{ perso[1] }}</option>
                                {% endfor %}
                            </select>                                
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-3" style="text-align: right;">
                            <label class="form-label" >Tipo:</label>                            
                        </div>
                        <div class="col-md-9" style="text-align: left;">
                            <select class="form-select" id="cboAporte" name="cboAporte">
                                <option selected="selected" value="">Seleccione Tipo de Aporte</option>
                                {% for tipoaporte in listatipoaporte %}
                                    <option value="{{ tipoaporte[0] }}">{{ tipoaporte[1] }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-md-3" style="text-align: right;">
                            <label class="form-label" >Fecha:</label>                            
                        </div>
                        <div class="col-md-9" style="text-align: left;">                            
                            <input type="date" class="form-control" style="width: auto;" id="txt_fecha" name="txt_fecha" placeholder="Seleccione una fecha" min="2025-01-01" max="2030-12-31">
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-3" style="text-align: right;">
                            <label class="form-label" >Turno:</label>                            
                        </div>
                        <div class="col-md-9" style="text-align: left;">
                            <select class="form-select" id="cboTurno" name="cboTurno">
                                <option selected="selected" value="">Seleccione un Turno</option>
                                <option value="M">Mañana</option>
                                <option value="T">Tarde</option>
                                <option value="N">Noche</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-md-3" style="text-align: right;">
                            <label class="form-label" >Monto:</label>                            
                        </div>
                        <div class="col-md-9" style="text-align: left;">                            
                            <input type="text" maxlength="10" style="width: auto;" autocomplete="off" class="form-control" id="txt_monto" name="txt_monto" placeholder="Ejm:  0.00">
                        </div>
                    </div>

                    <div id="mensaje" style="color:red; margin-top:10px;"></div>
                    <br><br>
                    <div class="row mb-3">
                        <div class="col-md-3"></div>
                        <div class="col-md-6" style="text-align: center;">
                            <button type="submit" name="action" value="guardar" class="btn btn-success w-100">Guardar</button>
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-3"></div>
                        <div class="col-md-6" style="text-align: center;">
                            <button type="button" id="btnCerrar" class="btn btn-outline-danger w-100" data-bs-dismiss="modal">Cerrar</button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
        </div>
    </div>


    <!-- JS -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <!-- esto -->
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

    <!-- DataTables + integración Bootstrap 5 -->
    <script src="https://cdn.datatables.net/1.13.8/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.8/js/dataTables.bootstrap5.min.js"></script>
    <script src="https://cdn.datatables.net/responsive/2.5.0/js/dataTables.responsive.min.js"></script>
    <script src="https://cdn.datatables.net/responsive/2.5.0/js/responsive.bootstrap5.min.js"></script>

    <script>
        const monto = document.getElementById('txt_monto');
        monto.addEventListener('input', function(event) {
            // Elimina todos los caracteres que no sean dígitos.
            this.value = this.value.replace(/[^0-9.]/g, '');
            // Si hay más de un punto, elimina el último
            const partes = this.value.split('.');
            if (partes.length > 2) {
                this.value = partes[0] + '.' + partes.slice(1).join('').replace(/\./g, '');
            }
        });

        const opcionesIniciales = {
            responsive: true,
            pageLength: 10,
            lengthMenu: [[10, 25, 50, 100, -1], [10, 25, 50, 100, 'Todos']],
            deferRender: true,
            language: { url: 'https://cdn.datatables.net/plug-ins/1.13.8/i18n/es-ES.json' },
            dom: "<'row mb-2'<'col-sm-6'l><'col-sm-6'f>> <'row'<'col-12'tr>> <'row mt-2'<'col-sm-5'i><'col-sm-7'p>>",
            columns: [
                { "data": "" },
                { "data": "tipoaprte" },
                { "data": "fecha_aporte" },
                { "data": "turno", className: "dt-center" },
                { "data": "monto", className: "dt-center" },
                { "data": "" }
            ],
            columnDefs: [
                {
                    targets: [0],
                    render: function (data, type, row, meta) {
                        return meta.row + 1;
                    }
                },
                {
                    targets: [1,2,3,4],
                    orderable: false,  // desactiva ordenamiento
                    searchable: false  // desactiva búsqueda
                }
            ]
        };
        /*******************************************************************************/
        $(document).ready(function () {
            let dt = $('#tablaAportes').DataTable(opcionesIniciales);
            
            document.getElementById("btnCerrar").addEventListener("click", () => {
                document.getElementById("cboTurno").value = "";
                document.getElementById("txt_fecha").value = "";
                document.getElementById("cboAporte").value = "";
                document.getElementById("txt_monto").value = "";
            });
            /*------------------------------------------------------------------------------*/
            document.getElementById("btnNuevoAporte").addEventListener("click", () => {
                document.getElementById("cboTurno").value = "";
                document.getElementById("txt_fecha").value = "";
                document.getElementById("cboAporte").value = "";
                document.getElementById("txt_monto").value = "";
            });                        
        });
        /*******************************************************************************/
        // Inicializa/rehace Select2 cuando el modal ya está abierto
        document.getElementById('Aporte-modal').addEventListener('shown.bs.modal', function () {
            const $sele = $('#cboPersona');

            // Si ya estaba inicializado, destrúyelo para evitar duplicados
            if ($sele.data('select2')) {
                $sele.select2('destroy');
            }

            $sele.select2({
                width: '100%',
                dropdownParent: $('#Aporte-modal'),
                placeholder: 'Seleccionar...'
                //minimumResultsForSearch: 0  // fuerza que aparezca la caja de búsqueda
            });

            // (Opcional) abrir automáticamente el buscador al mostrar el modal
            //$sel.select2('open');
        });
        /*******************************************************************************/
        document.addEventListener('click', async (e) => {
            const img = e.target.closest('#btnEditar'); //.imgEditar
            if (!img) return;

            const codigo = img.dataset.id;
            document.getElementById('valorCode').value = codigo;

            try {
                const resp = await fetch(`/edit_aporte/${codigo}`, { headers: { 'Accept': 'application/json' }, cache: 'no-store' });
                if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
                const minis = await resp.json();
                alert(minis);
                document.getElementById('cboAporte').value  = minis.aporte; //'D';
                document.getElementById('txt_fecha').value = minis.fecha; //'2025-05-04';
                document.getElementById('cboTurno').value  = minis.turno;                
                document.getElementById('txt_monto').value= minis.monto;
                
            } catch (err) {
                alert(err.message);
            }
        });
        /*******************************************************************************/
        async function cargarTabla() {
            alert("recarga");
            // try {
            //     const res = await fetch('/tblministerios', { cache: 'no-store' });
            //     const htmlTabla = await res.text();

            //     // Si ya estaba inicializada, destrúyela antes de cambiar el DOM
            //     if ($.fn.DataTable.isDataTable('#tablaPersonas')) {
            //         $('#tablaPersonas').DataTable().destroy();
            //     }
                
            //     $('#tablaPersonas tbody').html(htmlTabla);     // inserta las <tr> renderizadas
            //     $('#tablaPersonas').DataTable(opcionesIniciales);
            // } catch (e) {
            //     console.error('Error cargando tabla:', e);
            // }
        }
    </script>

</body>
</html>

{% endblock %}