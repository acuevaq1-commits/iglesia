{% extends "base.html" %}

{% block title %}Tab 1{% endblock %}

{% block content %}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Responsabilidades</title>
    <style>
        .error { color: red; font-size: 0.9rem; }
        input.invalid { border-color: red; }

        input::placeholder {        
        font-style: italic;
        }

        /* Activo */
        #tablaResponsabilidad_wrapper .page-item.active .page-link {
        background: #e90e0e;
        border-color: #e90e0e;
        color: #fff;
        }

        /* Hover */
        #tablaResponsabilidad_wrapper .page-link:hover {
        background: #e5f2fb;
        border-color: #000000;
        }

        /* Deshabilitado */
        #tablaResponsabilidad_wrapper .page-item.disabled .page-link {
        background: #f9fafb;
        color: #9ca3af;
        border-color: #e5e7eb;
        }

        /* (Opcional) si usas Bootstrap */
        #tablaResponsabilidad.table thead th {
        background-color: #f67b00;
        color: #fff;
        }

        .table.display  tbody tr:nth-child(odd) td,
        .table.display tbody tr:nth-child(odd) th {
        background-color: #ffe1b6;
        }

        .table.display tbody tr:nth-child(even) td,
        .table.display tbody tr:nth-child(even) th {
        background-color: #fbecda;
        color:#000000;
        }
    </style>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-GLhlTQ8iRABdZLl6O3oVMWSktQOp6b7In1Zl3/Jr59b6EGGoI1aFkw7cmDA6j6gD" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js" integrity="sha384-w76AqPfDkMBDXo30jS1Sgez6pr3x5MlQ1ZAGC+nuZB+EYdgRZgiwxhTBTkF7CXvN" crossorigin="anonymous"></script>
    
    <!-- Bootstrap 5 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- DataTables + integración Bootstrap 5 -->
    <link href="https://cdn.datatables.net/1.13.8/css/dataTables.bootstrap5.min.css" rel="stylesheet">
    <link href="https://cdn.datatables.net/responsive/2.5.0/css/responsive.bootstrap5.min.css" rel="stylesheet">
</head>
<body>
    <nav class="navbar navbar-expand-lg bg-light">
        <div class="container-fluid">
            <a class="navbar-brand fw-bolder"> | Responsabilidades | </a>
            <span>Bienvenido/a {{session['name']}} {{session['surnames']}}<a href="{{url_for('logout')}}" class="mx-3">Salir</a></span>
        </div>
    </nav>


    <div class="container">
        <div style="width: 100%; margin: 30px auto;">
            <button class="btn btn-primary btn-sm" id="btnNuevaResponsabilidad" data-bs-toggle="modal" data-bs-target="#Respo-modal" title="Nueva Responsabilidad">
                &nbsp;&nbsp;&nbsp;<i class="bi bi-clipboard2-check-fill" width='18px' style="cursor:pointer;"></i>
                Nueva Responsabilidad &nbsp;&nbsp;&nbsp;
            </button>
            <br><br>
            <table id="tablaResponsabilidades" class="display table table-striped table-hover table-bordered table-sm align-middle" style="width:100%">
                <thead>                
                    <tr>
                        <th>Item</th>
                        <th>Fecha</th>
                        <th>Turno</th>
                        <th>Dirigente</th>
                        <th>Enseñanza</th>                        
                        <th>L.Bíblica</th>
                        <th>Limpieza</th>
                        <th>Ujier</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    {% include "_responsabilidad.html" %}
                </tbody>
            </table>
            <div id="msjTabla" style="color:red; margin-top:10px;"></div>                      
        </div>
    </div>


    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
            <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
                {{ message }}
                cccmnmn<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
            {% endfor %}
        {% endif %}
    {% endwith %}


    <!-- Ingresar Responsabilidades -->
    <div class="modal fade" id="Respo-modal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h1 class="modal-title fs-5" id="exampleModalLabel"> :: Responsabilidad :: </h1>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">

                <form id="formResponsabilidad" action="/nueva_responsabilidad" method="post">
                    <input id="valorCode" name="valorCode" type="hidden"/>
                    <div class="row mb-3">
                        <div class="col-md-3" style="text-align: right;">
                            <label class="form-label" >Fecha:</label>
                        </div>
                        <div class="col-md-9" style="text-align: left;">                            
                            <input type="date" class="form-control" style="width: auto;" id="fecha_txt" name="fecha_txt" placeholder="Seleccione una fecha" min="2025-01-01" max="2030-12-31"> <!--min="2025-01-01" max="2025-12-31"-->
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-3" style="text-align: right;">
                            <label class="form-label" >Turno:</label>
                        </div>
                        <div class="col-md-9" style="text-align: left;">                            
                            <select class="form-select" id="cboTurno" name="cboTurno">
                                <option value="">Seleccione un Turno</option>
                                <option value="M">Turno Mañana</option>
                                <option value="T">Turno Tarde</option>
                                <option value="N">Turno Noche</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-md-3" style="text-align: right;">
                            <label class="form-label" >Dirigente:</label>
                        </div>
                        <div class="col-md-9" style="text-align: left;">                            
                            <select class="form-select" id="cboDirigente" name="cboDirigente">
                                <option value="">Seleccione un dirigente</option>
                                {% for dirig in dirigentes %}
                                    <option value="{{ dirig[0] }}">{{ dirig[1] }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-md-3" style="text-align: right;">
                            <label class="form-label" >Ujier:</label>                            
                        </div>
                        <div class="col-md-9" style="text-align: left;">                            
                            <select class="form-select" id="cboUjier" name="cboUjier">
                                <option value="">Seleccione un Ujier</option>
                                {% for ujier in ujieres %}
                                    <option value="{{ ujier[0] }}">{{ ujier[1] }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-3" style="text-align: right;">
                            <label class="form-label" >Lectura:</label> 
                        </div>
                        <div class="col-md-9" style="text-align: left;">                            
                            <select class="form-select" id="cboLectura" name="cboLectura">
                                <option value="">Seleccione un responsable para lectura bíblica</option>
                                {% for lectu in lecturas %}
                                    <option value="{{ lectu[0] }}">{{ lectu[1] }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-3" style="text-align: right;">
                            <label class="form-label" >Enseñanza:</label>                            
                        </div>
                        <div class="col-md-9" style="text-align: left;">                            
                            <select class="form-select" id="cboPredicador" name="cboPredicador">
                                <option value="">Seleccione el Predicador</option>
                                {% for predi in Predicadores %}
                                    <option value="{{ predi[0] }}">{{ predi[1] }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-3" style="text-align: right;">
                            <label class="form-label" >Limpieza:</label>                            
                        </div>
                        <div class="col-md-9" style="text-align: left;">                            
                            <select class="form-select" id="cboLimpieza" name="cboLimpieza">
                                <option value="">Elije un(os) responsables para la limpieza</option>
                                {% for limpi in Limpiadores %}
                                    <option value="{{ limpi[0] }}">{{ limpi[1] }}</option>
                                {% endfor %}
                        </select>
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-3" style="text-align: right;">
                            <label class="form-label" >Santa Cena:</label>                            
                        </div>
                        <div class="col-md-9" style="text-align: left;">                            
                            <select class="form-select" id="cboSantaCena" name="cboSantaCena">
                                <option value="">Elije un(os) responsables para la Santa Cena</option>
                                {% for santa in SantaCena %}
                                    <option value="{{ santa[0] }}">{{ santa[1] }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-3" style="text-align: right;">
                            <label class="form-label" >Comensales:</label>                            
                        </div>
                        <div class="col-md-9" style="text-align: left;">                            
                            <select class="form-select" id="cboComensales" name="cboComensales">
                                <option value="">Elije un(os) responsables para comensales</option>
                                {% for comen in Comensales %}
                                    <option value="{{ comen[0] }}">{{ comen[1] }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    <div id="mensaje" style="color:red; margin-top:10px;"></div>
                    <br><br>
                    <div class="row mb-3">
                        <div class="col-md-3"></div>
                        <div class="col-md-6" style="text-align: center;">
                            <button type="submit" class="btn btn-primary w-100">Guardar</button>
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-3"></div>
                        <div class="col-md-6" style="text-align: center;">
                            <button type="button" id="btnCerrar" class="btn btn-outline-danger w-100" data-bs-dismiss="modal">Cerrar</button>
                        </div>
                    </div>

                </form>
            </div>
        </div>
        </div>
    </div>

    <!-- Historial -->
    <div class="modal fade" id="CambiosModal" tabindex="-1" aria-labelledby="exampleModalHistorial" aria-hidden="true">        
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h1 class="modal-title fs-5" id="exampleModalHistorial"> :: Cambios :: </h1>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="HistorialModalBody">
                    <table id="tablaCambios" class="display table table-striped table-hover table-bordered table-sm align-middle" style="width:100%">                    
                        <thead>
                            <tr>
                                <th style="text-align: center; width: 5%;">Item</th>
                                <th style="text-align: center; width: 25%;">Campo1</th>
                                <th style="text-align: center; width: 25%;">Campo2</th>
                                <th style="text-align: center; width: 15%;">Campo3</th>
                                <th style="text-align: center; width: 15%;">Campo4</th>
                                <th style="text-align: center; width: 15%;">Campo5</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% include "_responsabilidad.html" %}
                        </tbody>
                    </table>                    
                </div>
            </div>                
        </div>
    </div>

    <!-- JS -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <!-- DataTables + integración Bootstrap 5 -->
    <script src="https://cdn.datatables.net/1.13.8/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.8/js/dataTables.bootstrap5.min.js"></script>
    <script src="https://cdn.datatables.net/responsive/2.5.0/js/dataTables.responsive.min.js"></script>
    <script src="https://cdn.datatables.net/responsive/2.5.0/js/responsive.bootstrap5.min.js"></script>

    <script>
        const opcionesIniciales = {
            responsive: true,
            pageLength: 10,
            lengthMenu: [[10, 25, 50, 100, -1], [8, 25, 50, 100, 'Todos']],
            deferRender: true,
            language: { url: 'https://cdn.datatables.net/plug-ins/1.13.8/i18n/es-ES.json' },
            dom: "<'row mb-2'<'col-sm-6'l><'col-sm-6'f>> <'row'<'col-12'tr>> <'row mt-2'<'col-sm-5'i><'col-sm-7'p>>",
            columns: [
                { "data": "" },
                { "data": "fecha"},
                { "data": "turno"},
                { "data": "dirigente"},
                { "data": "enseñanza"},
                { "data": "lectura"},
                { "data": "limpieza"},
                { "data": "ujier"},
                { "data": "comensales"}
            ],
            columnDefs: [
                {
                    targets: [0],
                    render: function (data, type, row, meta) {
                        return meta.row + 1;
                    }
                },
                {
                    targets: [2,3,4,5],
                    orderable: false,  // desactiva ordenamiento
                    searchable: false  // desactiva búsqueda
                }
            ]
        };
        /*******************************************************************************/
        const opcionesCambios = {
            responsive: true,
            pageLength: 10,
            lengthMenu: [[10, 25, 50, 100, -1], [10, 25, 50, 100, 'Todos']],            
            deferRender: true,
            language: { url: 'https://cdn.datatables.net/plug-ins/1.13.8/i18n/es-ES.json' },            
            dom: "<'row mb-2'<'col-sm-6'l><'col-sm-6'f>> <'row'<'col-12'tr>> <'row mt-2'<'col-sm-5'i><'col-sm-7'p>>",            
            columns: [
                { "data": "" },
                { "data": "nombres" },                
                { "data": "email", className: "dt-center" },
                { "data": "fecha_actividad" },
                { "data": "fecha_cierre" , className: "dt-center" },
                { "data": "ippp" }
            ],
            columnDefs: [
                {
                    targets: [0],
                    render: function (data, type, row, meta) {
                        return meta.row + 1;
                    }
                },
                {
                    targets: [1,2,3,4,5],
                    orderable: false,  // desactiva ordenamiento
                    searchable: false  // desactiva búsqueda
                }
            ]
        }
        /*******************************************************************************/
        $(document).ready(function () {
            cargarTabla();
            let dt = $('#tablaResponsabilidades').DataTable(opcionesIniciales);

            document.getElementById("btnCerrar").addEventListener("click", () => {            
                document.getElementById("fecha_txt").value = "";
                document.getElementById("cboTurno").value = "";
                document.getElementById("cboDirigente").value = "";
                document.getElementById("cboUjier").value = "";
                document.getElementById("cboLectura").value = "";
                document.getElementById("cboPredicador").value = "";
                document.getElementById("cboLimpieza").value = "";
                document.getElementById("cboSantaCena").value = "";
                document.getElementById("cboComensales").value = "";
                document.getElementById("mensaje").textContent = "";
            });
            /*------------------------------------------------------------------------------*/
            document.getElementById("btnNuevaResponsabilidad").addEventListener("click", () => {
                document.getElementById("fecha_txt").value = "";
                document.getElementById("cboTurno").value = "";
                document.getElementById("cboDirigente").value = "";
                document.getElementById("cboUjier").value = "";
                document.getElementById("cboLectura").value = "";
                document.getElementById("cboPredicador").value = "";
                document.getElementById("cboLimpieza").value = "";
                document.getElementById("cboSantaCena").value = "";
                document.getElementById("cboComensales").value = "";
                document.getElementById("mensaje").textContent = "";
            }); 
            /*------------------------------------------------------------------------------*/
            document.getElementById("formResponsabilidad").addEventListener("submit", async (e) => {
                //alert("submit");
                codigo = document.getElementById('valorCode').value;

                e.preventDefault(); // evitar recargar
                const formData = new FormData(e.target);
                const response = await fetch("/nueva_responsabilidad", { method: "POST", body: formData });

                const data = await response.json();
                const mensaje = document.getElementById("mensaje");
                
                if (data.error) {
                    mensaje.style.color = "red";
                    mensaje.textContent = data.error;
                } else if (data.success) {
                    mensaje.style.color = "green";
                    mensaje.textContent = data.success;
                    //e.target.reset(); // limpiar formulario
                    cargarTabla();
                }
            });
            /*------------------------------------------------------------------------------*/
            document.addEventListener('click', async (e) => {              
                const img = e.target.closest('.imgCambios');
                if (!img) return;
                const codigo = img.dataset.id;

                try {
                    const resp = await fetch(`/tblCambiosRespo/${codigo}`, { headers: { 'Accept': 'text/html' }, cache: 'no-store' });
                    const htmlTabla = await resp.text();
                    //alert("htmlTabla: " + htmlTabla);
                    // Si ya estaba inicializada, destrúyela antes de cambiar el DOM                
                    if ($.fn.DataTable.isDataTable('#tablaCambios')) {
                        $('#tablaCambios').DataTable().destroy();
                    }

                    $('#tablaCambios tbody').html(htmlTabla);
                    $('#tablaCambios').DataTable(opcionesHistorial);

                } catch (err) {
                    alert(err.message);
                }
            });
        })
        /*******************************************************************************/
        $(document).on('click', '#tablaResponsabilidades tbody .btnEliminar', function (e) {
            e.preventDefault();
            const mensajeDiv = document.getElementById("msjTabla");
            const url = this.dataset.url || this.href;
            if (!confirm('¿Confirma que desea eliminar registro?')) return;

            fetch(url)
                .then(r => r.json()) // ✅ convierte la respuesta a JSON
                    .then(data => {

                    if (data.status) {
                        alertHTML = '<div class="alert alert-info alert-dismissible fade show mt-2" role="alert"> ' + data.mensaje +' <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Cerrar"></button></div>';
                    } else
                        alertHTML = '<div class="alert alert-danger alert-dismissible fade show mt-2" role="alert"> ❌ ' + data.mensaje +' <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Cerrar"></button></div>';
                    
                    mensajeDiv.innerHTML = alertHTML;
                    setTimeout(() => {
                        const alerta = mensajeDiv.querySelector(".alert");
                        if (alerta) {
                            alerta.classList.remove("show"); // inicia la animación de fade
                            alerta.classList.add("hide");                            
                            alerta.addEventListener("transitionend", () => alerta.remove()); // quitar del DOM tras animación (opcional)
                        }
                    }, 3000);                        
                })
                .then(() => cargarTablaUsuario())
                .catch(err => alert('Error eliminando: ' + err.message));
        });
        /*******************************************************************************/
        document.addEventListener("DOMContentLoaded", () => {

            // alert(document.querySelectorAll('#tablaHistorial').length);
            // alert(document.querySelectorAll('#HistorialModal').length);
            // const t = document.querySelector('#tablaHistorial');
            // alert("contains: " + document.getElementById("HistorialModal").contains(t));
            // alert("contains: " + document.getElementById("DIVXXX").contains(t));
            
            const modal = document.getElementById("HistorialModalBody");
            const tabla = document.getElementById("tablaCambios");

            // Mover la tabla dentro del div
            if (modal && tabla) {
                modal.appendChild(tabla);
            } else {
                alert("No se encontró el div o la tabla");
            }
            /*-------------------------------------------------------------------------*/
            document.addEventListener('click', async (e) => {              
                const img = e.target.closest('.imgEditar');
                if (!img) return;

                const codigo = img.dataset.id;                
                document.getElementById('valorCode').value = codigo;

                try {
                    const resp = await fetch(`/edit_responsabilidad/${codigo}`, { headers: { 'Accept': 'application/json' }, cache: 'no-store' });
                    if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
                    const respo = await resp.json();

                    document.getElementById('fecha_txt').value   = respo.fecha;
                    document.getElementById('cboTurno').value   = respo.turno;                    
                    document.getElementById('cboDirigente').value  = respo.dirigente;
                    document.getElementById('cboUjier').value   = respo.ujier;
                    document.getElementById('cboLectura').value   = respo.lectura;
                    document.getElementById('cboPredicador').value= respo.enseñanza;                    
                    document.getElementById('cboLimpieza').value   = respo.limpieza;
                    document.getElementById('cboSantaCena').value   = respo.santacena;
                    document.getElementById('cboComensales').value   = respo.comensales;
                } catch (err) {
                    alert(err.message);
                }
            });
        });
        /*******************************************************************************/
        async function cargarTabla() {
            try {
                const res = await fetch('/tblresponsabilidades', { cache: 'no-store' });
                const htmlTabla = await res.text();

                // Si ya estaba inicializada, destrúyela antes de cambiar el DOM
                if ($.fn.DataTable.isDataTable('#tablaResponsabilidades')) {
                    $('#tablaResponsabilidades').DataTable().destroy();
                }
                
                $('#tablaResponsabilidades tbody').html(htmlTabla); // inserta las <tr> renderizadas
                $('#tablaResponsabilidades').DataTable(opcionesIniciales);
            } catch (e) {
                alert(e);
                console.error('Error cargando tabla:', e);
            }            
        }
    </script>

</body>
</html>

{% endblock %}